<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <?!= include('UI/styles'); ?>
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <style>
    body {
      font-family: 'Roboto', Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f5f5f5;
      color: #333;
    }
    
    .app-container {
      display: flex;
      min-height: 100vh;
    }
    
    .sidebar {
      width: 250px;
      background-color: #4285f4;
      color: white;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
      z-index: 100;
      transition: transform 0.3s ease;
    }
    
    .sidebar-header {
      padding: 20px;
      text-align: center;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .sidebar-header h2 {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 400;
    }
    
    .sidebar-header p {
      margin: 5px 0 0;
      font-size: 0.9rem;
      opacity: 0.8;
    }
    
    .nav-menu {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .nav-item {
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .nav-link {
      display: flex;
      align-items: center;
      padding: 15px 20px;
      color: white;
      text-decoration: none;
      transition: background-color 0.2s;
    }
    
    .nav-link:hover {
      background-color: rgba(255,255,255,0.1);
    }
    
    .nav-link.active {
      background-color: rgba(255,255,255,0.2);
      font-weight: 500;
    }
    
    .nav-link i {
      margin-right: 10px;
    }
    
    .main-content {
      flex: 1;
      padding: 0;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    
    .top-bar {
      display: flex;
      align-items: center;
      padding: 0 20px;
      height: 64px;
      background-color: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      z-index: 50;
    }
    
    .menu-toggle {
      margin-right: 20px;
      cursor: pointer;
      display: none;
    }
    
    .page-title {
      flex: 1;
      margin: 0;
      font-size: 1.25rem;
      font-weight: 500;
    }
    
    .user-info {
      display: flex;
      align-items: center;
    }
    
    .user-name {
      margin-right: 10px;
    }
    
    .content-area {
      flex: 1;
      padding: 20px;
      background-color: #f5f5f5;
    }
    
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .card {
      background-color: white;
      border-radius: 4px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
      padding: 20px;
      margin-bottom: 20px;
      overflow: hidden;
    }
    
    .card h3 {
      margin-top: 0;
      color: #4285f4;
      font-weight: 500;
      display: flex;
      align-items: center;
    }
    
    .card h3 i {
      margin-right: 8px;
    }
    
    .card-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 15px;
    }
    
    .btn {
      display: inline-flex;
      align-items: center;
      background-color: #4285f4;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      text-decoration: none;
      transition: background-color 0.2s;
    }
    
    .btn:hover {
      background-color: #3367d6;
    }
    
    .btn i {
      margin-right: 6px;
    }
    
    .btn-secondary {
      background-color: #f1f3f4;
      color: #3c4043;
    }
    
    .btn-secondary:hover {
      background-color: #e8eaed;
    }
    
    .table-responsive {
      width: 100%;
      overflow-x: auto;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
    }
    
    th {
      font-weight: 500;
      color: #3c4043;
      background-color: #f1f3f4;
    }
    
    tr:hover {
      background-color: #f5f5f5;
    }
    
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 200px;
    }
    
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #4285f4;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      .app-container {
        flex-direction: column;
      }
      
      .sidebar {
        width: 100%;
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        transform: translateX(-100%);
      }
      
      .sidebar.open {
        transform: translateX(0);
      }
      
      .main-content {
        margin-left: 0;
      }
      
      .menu-toggle {
        display: block;
      }
      
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <h2>QA Platform</h2>
        <p id="userRoleDisplay"></p>
      </div>
      <ul class="nav-menu" id="navMenu">
        <li class="nav-item">
          <a href="#" class="nav-link active" data-page="dashboard">
            <i class="material-icons">dashboard</i> Dashboard
          </a>
        </li>
        <li class="nav-item" id="navEvaluation">
          <a href="#" class="nav-link" data-page="evaluation">
            <i class="material-icons">assignment</i> New Evaluation
          </a>
        </li>
        <li class="nav-item" id="navDispute">
          <a href="#" class="nav-link" data-page="dispute">
            <i class="material-icons">gavel</i> File Dispute
          </a>
        </li>
        <li class="nav-item" id="navReview">
          <a href="#" class="nav-link" data-page="review">
            <i class="material-icons">rate_review</i> Review Disputes
          </a>
        </li>
        <li class="nav-item" id="navUsers">
          <a href="#" class="nav-link" data-page="users">
            <i class="material-icons">people</i> User Management
          </a>
        </li>
        <li class="nav-item" id="navAdmin">
          <a href="#" class="nav-link" data-page="admin">
            <i class="material-icons">settings</i> Admin Panel
          </a>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link" id="helpLink">
            <i class="material-icons">help</i> Help
          </a>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link" id="logoutLink">
            <i class="material-icons">exit_to_app</i> Logout
          </a>
        </li>
      </ul>
    </div>
    
    <div class="main-content">
      <div class="top-bar">
        <div class="menu-toggle" id="menuToggle">
          <i class="material-icons">menu</i>
        </div>
        <h2 class="page-title" id="pageTitle">Dashboard</h2>
        <div class="user-info">
          <span class="user-name" id="userName"></span>
          <i class="material-icons">account_circle</i>
        </div>
      </div>
      
      <div class="content-area" id="contentArea">
        <!-- Content will be loaded here -->
        <div class="loading">
          <div class="spinner"></div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Help Dialog -->
  <div id="helpDialog" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2>QA Platform Help</h2>
        <span class="close-button" id="closeHelpDialog">&times;</span>
      </div>
      <div class="modal-body">
        <h3>Key Features</h3>
        <ul>
          <li><strong>Dashboard:</strong> View performance metrics and recent activity</li>
          <li><strong>Evaluations:</strong> Create and manage agent evaluations</li>
          <li><strong>Disputes:</strong> File and review disputes for evaluations</li>
          <li><strong>Admin Panel:</strong> Manage question sets, users, and system settings</li>
        </ul>
        <h3>User Roles</h3>
        <ul>
          <li><strong>Agent:</strong> Can view their own evaluations and metrics</li>
          <li><strong>Agent Manager:</strong> Can view team evaluations and file disputes</li>
          <li><strong>QA Analyst:</strong> Can create evaluations</li>
          <li><strong>QA Manager:</strong> Can review disputes and generate reports</li>
          <li><strong>Admin:</strong> Has full system access</li>
        </ul>
        <p>For additional assistance, please contact your system administrator.</p>
      </div>
    </div>
  </div>
  
  <?!= include('UI/scripts'); ?>
  
  <script>
    // User information
    let userInfo = {};
    
    // Current page
    let currentPage = 'dashboard';
    
    // Initialize the application
    function initApp() {
      // Get user info
      google.script.run
        .withSuccessHandler(handleUserInfo)
        .withFailureHandler(handleError)
        .getUserInfo();
      
      // Add event listeners
      document.getElementById('menuToggle').addEventListener('click', toggleSidebar);
      document.getElementById('helpLink').addEventListener('click', showHelpDialog);
      document.getElementById('closeHelpDialog').addEventListener('click', hideHelpDialog);
      document.getElementById('logoutLink').addEventListener('click', logout);
      
      // Set up navigation event listeners
      const navLinks = document.querySelectorAll('.nav-link[data-page]');
      navLinks.forEach(link => {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          const page = this.getAttribute('data-page');
          navigateTo(page);
        });
      });
    }
    
    // Handle user info
    function handleUserInfo(info) {
      userInfo = info;
      
      // Display user info
      document.getElementById('userName').textContent = info.name || info.email;
      document.getElementById('userRoleDisplay').textContent = formatRole(info.role);
      
      // Show/hide menu items based on role
      setupNavigation(info.role);
      
      // Load dashboard content
      loadDashboard();
    }
    
    // Format role for display
    function formatRole(role) {
      if (!role) return '';
      
      // Convert snake_case to Title Case
      return role
        .split('_')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
        .join(' ');
    }
    
    // Set up navigation based on user role
    function setupNavigation(role) {
      // Hide all role-specific items by default
      document.getElementById('navEvaluation').style.display = 'none';
      document.getElementById('navDispute').style.display = 'none';
      document.getElementById('navReview').style.display = 'none';
      document.getElementById('navUsers').style.display = 'none';
      document.getElementById('navAdmin').style.display = 'none';
      
      // Show items based on role
      if (role === 'qa_analyst' || role === 'qa_manager' || role === 'admin') {
        document.getElementById('navEvaluation').style.display = 'block';
      }
      
      if (role === 'agent_manager' || role === 'admin') {
        document.getElementById('navDispute').style.display = 'block';
      }
      
      if (role === 'qa_manager' || role === 'admin') {
        document.getElementById('navReview').style.display = 'block';
      }
      
      if (role === 'admin') {
        document.getElementById('navUsers').style.display = 'block';
        document.getElementById('navAdmin').style.display = 'block';
      }
    }
    
    // Navigate to a page
    function navigateTo(page) {
      // Update navigation links
      const navLinks = document.querySelectorAll('.nav-link');
      navLinks.forEach(link => {
        link.classList.remove('active');
        if (link.getAttribute('data-page') === page) {
          link.classList.add('active');
        }
      });
      
      // Update page title
      let pageTitle = 'Dashboard';
      switch (page) {
        case 'evaluation':
          pageTitle = 'New Evaluation';
          break;
        case 'dispute':
          pageTitle = 'File Dispute';
          break;
        case 'review':
          pageTitle = 'Review Disputes';
          break;
        case 'users':
          pageTitle = 'User Management';
          break;
        case 'admin':
          pageTitle = 'Admin Panel';
          break;
      }
      document.getElementById('pageTitle').textContent = pageTitle;
      
      // Show loading spinner
      document.getElementById('contentArea').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
      
      // Load the appropriate content
      currentPage = page;
      switch (page) {
        case 'dashboard':
          loadDashboard();
          break;
        case 'evaluation':
          loadEvaluationForm();
          break;
        case 'dispute':
          loadDisputeForm();
          break;
        case 'review':
          loadDisputeReview();
          break;
        case 'users':
          loadUserManagement();
          break;
        case 'admin':
          loadAdminPanel();
          break;
      }
      
      // Close the sidebar on mobile
      if (window.innerWidth <= 768) {
        document.getElementById('sidebar').classList.remove('open');
      }
    }
    
    // Load dashboard content
    function loadDashboard() {
      // Get dashboard data
      google.script.run
        .withSuccessHandler(renderDashboard)
        .withFailureHandler(handleError)
        .getDashboardData({ period: 'month' });
    }
    
    // Render dashboard
    function renderDashboard(data) {
      const contentArea = document.getElementById('contentArea');
      
      // Check for error
      if (data.error) {
        contentArea.innerHTML = `<div class="card"><h3>Error</h3><p>${data.error}</p></div>`;
        return;
      }
      
      // Start building dashboard HTML
      let html = `
        <div class="dashboard-grid">
          <div class="card">
            <h3><i class="material-icons">assessment</i> Evaluation Summary</h3>
            <div>
              <p><strong>${data.evaluationStats.totalEvaluations}</strong> evaluations</p>
              <p><strong>${data.evaluationStats.overallAveragePercentage}%</strong> average score</p>
              <p><strong>${data.evaluationStats.passRate}%</strong> pass rate</p>
            </div>
            <div class="card-actions">
              <a href="#" class="btn" onclick="navigateTo('evaluation')">
                <i class="material-icons">add</i> New Evaluation
              </a>
            </div>
          </div>
          
          <div class="card">
            <h3><i class="material-icons">gavel</i> Dispute Summary</h3>
            <div>
              <p><strong>${data.disputeStats.totalDisputes}</strong> disputes</p>
              <p><strong>${data.disputeStats.pendingCount}</strong> pending review</p>
              <p><strong>${data.disputeStats.approvalRate}%</strong> approval rate</p>
            </div>
            <div class="card-actions">
              <a href="#" class="btn" onclick="navigateTo('${userInfo.role === 'agent_manager' || userInfo.role === 'admin' ? 'dispute' : 'review'}')">
                <i class="material-icons">${userInfo.role === 'agent_manager' || userInfo.role === 'admin' ? 'add' : 'visibility'}</i> 
                ${userInfo.role === 'agent_manager' || userInfo.role === 'admin' ? 'File Dispute' : 'Review Disputes'}
              </a>
            </div>
          </div>
      `;
      
      // Add role-specific card
      if (data.roleSpecificData) {
        // Different content based on role
        switch (userInfo.role) {
          case 'agent':
            html += `
              <div class="card">
                <h3><i class="material-icons">person</i> Your Performance</h3>
                <div>
                  <p><strong>${data.roleSpecificData.passRate}%</strong> pass rate</p>
                  <p><strong>${data.roleSpecificData.totalEvaluations}</strong> evaluations this period</p>
                </div>
              </div>
            `;
            break;
            
          case 'agent_manager':
            html += `
              <div class="card">
                <h3><i class="material-icons">people</i> Team Performance</h3>
                <div>
                  <p><strong>${data.roleSpecificData.totalReports}</strong> team members</p>
                  <p><strong>${data.roleSpecificData.totalEvaluations}</strong> evaluations</p>
                  <p><strong>${data.roleSpecificData.pendingEvaluations}</strong> pending evaluations</p>
                </div>
              </div>
            `;
            break;
            
          case 'qa_analyst':
            html += `
              <div class="card">
                <h3><i class="material-icons">rate_review</i> Your Activity</h3>
                <div>
                  <p><strong>${data.roleSpecificData.totalEvaluations}</strong> evaluations performed</p>
                  <p><strong>${data.roleSpecificData.disputes ? data.roleSpecificData.disputes.rate : 0}%</strong> dispute rate</p>
                </div>
              </div>
            `;
            break;
            
          case 'qa_manager':
          case 'admin':
            html += `
              <div class="card">
                <h3><i class="material-icons">supervisor_account</i> System Overview</h3>
                <div>
                  <p><strong>${data.roleSpecificData.totalEvaluations}</strong> total evaluations</p>
                  <p><strong>${data.roleSpecificData.pendingDisputes}</strong> pending disputes</p>
                </div>
                <div class="card-actions">
                  <a href="#" class="btn" onclick="navigateTo('admin')">
                    <i class="material-icons">settings</i> Admin Panel
                  </a>
                </div>
              </div>
            `;
            break;
        }
      }
      
      // Close the grid
      html += `</div>`;
      
      // Add recent evaluations table
      html += `
        <div class="card">
          <h3><i class="material-icons">history</i> Recent Evaluations</h3>
          <div class="table-responsive">
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Agent</th>
                  <th>Evaluator</th>
                  <th>Interaction Type</th>
                  <th>Score</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
      `;
      
      // Add recent evaluations rows
      if (data.recentEvaluations && data.recentEvaluations.length > 0) {
        data.recentEvaluations.forEach(eval => {
          const date = new Date(eval.Date).toLocaleDateString();
          const scorePercentage = Math.round((eval.Score / eval['Max Possible']) * 100);
          
          html += `
            <tr>
              <td>${date}</td>
              <td>${eval.Agent}</td>
              <td>${eval.Evaluator}</td>
              <td>${eval['Interaction Type'] || 'N/A'}</td>
              <td>${eval.Score}/${eval['Max Possible']} (${scorePercentage}%)</td>
              <td>${eval.Status}</td>
              <td>
                <button class="btn btn-secondary" onclick="viewEvaluation('${eval.ID}')">
                  <i class="material-icons">visibility</i> View
                </button>
              </td>
            </tr>
          `;
        });
      } else {
        html += `<tr><td colspan="7" style="text-align: center;">No recent evaluations found</td></tr>`;
      }
      
      // Close the table
      html += `
              </tbody>
            </table>
          </div>
        </div>
      `;
      
      // Set the content
      contentArea.innerHTML = html;
    }
    
    // Load evaluation form
    function loadEvaluationForm() {
      // Placeholder for evaluation form loading
      const contentArea = document.getElementById('contentArea');
      contentArea.innerHTML = '<div class="card"><h3>Evaluation Form</h3><p>Loading evaluation form...</p></div>';
      
      // In a real implementation, you would load the evaluation form here
      // Example:
      // google.script.run
      //   .withSuccessHandler(renderEvaluationForm)
      //   .withFailureHandler(handleError)
      //   .getEvaluationFormData();
    }
    
    // Load dispute form
    function loadDisputeForm() {
      // Placeholder for dispute form loading
      const contentArea = document.getElementById('contentArea');
      contentArea.innerHTML = '<div class="card"><h3>Dispute Form</h3><p>Loading dispute form...</p></div>';
    }
    
    // Load dispute review
    function loadDisputeReview() {
      // Placeholder for dispute review loading
      const contentArea = document.getElementById('contentArea');
      contentArea.innerHTML = '<div class="card"><h3>Dispute Review</h3><p>Loading dispute review...</p></div>';
    }
    
    // Load user management
    function loadUserManagement() {
      // Placeholder for user management loading
      const contentArea = document.getElementById('contentArea');
      contentArea.innerHTML = '<div class="card"><h3>User Management</h3><p>Loading user management...</p></div>';
    }
    
    // Load admin panel
    function loadAdminPanel() {
      // Placeholder for admin panel loading
      const contentArea = document.getElementById('contentArea');
      contentArea.innerHTML = '<div class="card"><h3>Admin Panel</h3><p>Loading admin panel...</p></div>';
    }
    
    // View evaluation details
    function viewEvaluation(evaluationId) {
      // Placeholder for viewing evaluation details
      alert(`View evaluation: ${evaluationId}`);
    }
    
    // Toggle sidebar on mobile
    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('open');
    }
    
    // Show help dialog
    function showHelpDialog(e) {
      e.preventDefault();
      document.getElementById('helpDialog').style.display = 'block';
    }
    
    // Hide help dialog
    function hideHelpDialog() {
      document.getElementById('helpDialog').style.display = 'none';
    }
    
    // Logout function
    function logout(e) {
      e.preventDefault();
      
      // In Google Apps Script, we can't really "log out" the user,
      // but we can redirect to the login page
      window.top.location.href = '<?= ScriptApp.getService().getUrl(); ?>?page=login';
    }
    
    // Handle errors
    function handleError(error) {
      console.error('Error:', error);
      document.getElementById('contentArea').innerHTML = `
        <div class="card">
          <h3><i class="material-icons">error</i> Error</h3>
          <p>${error}</p>
        </div>
      `;
    }
    
    // Initialize the app when the page loads
    document.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>